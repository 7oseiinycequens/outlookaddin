<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <title>Commands</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    <script>
        Office.onReady(function() {
            // Register the function
            Office.actions.associate("sendEmailToWebhook", sendEmailToWebhook);
        });

        function sendEmailToWebhook(event) {
            try {
                const item = Office.context.mailbox.item;
                
                // Get email subject
                item.subject.getAsync(function(resultSubject) {
                    if (resultSubject.status === Office.AsyncResultStatus.Succeeded) {
                        const subject = resultSubject.value || "(No subject)";
                        
                        // Get email body
                        item.body.getAsync(Office.CoercionType.Text, function(resultBody) {
                            if (resultBody.status === Office.AsyncResultStatus.Succeeded) {
                                const body = resultBody.value || "(No body)";
                                
                                // Create email data object
                                const emailData = {
                                    subject: subject,
                                    body: body,
                                    from: Office.context.mailbox.userProfile.emailAddress,
                                    timestamp: new Date().toISOString()
                                };
                                
                                // Send to webhook
                                fetch('https://2160cc8fd8f2.ngrok-free.app/webhook', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify(emailData)
                                })
                                .then(function(response) {
                                    if (!response.ok) {
                                        throw new Error('Network response was not ok');
                                    }
                                    return response.json();
                                })
                                .then(function(data) {
                                    console.log("Email sent to webhook successfully");
                                    // Complete the event
                                    event.completed();
                                })
                                .catch(function(error) {
                                    console.error('Error sending to webhook:', error);
                                    // Complete the event
                                    event.completed();
                                });
                            } else {
                                console.error("Error getting email body");
                                event.completed();
                            }
                        });
                    } else {
                        console.error("Error getting email subject");
                        event.completed();
                    }
                });
            } catch (error) {
                console.error("Error in sendEmailToWebhook:", error);
                event.completed();
            }
        }
    </script>
</head>
<body>
    <!-- This file is used only for function execution -->
</body>
</html>